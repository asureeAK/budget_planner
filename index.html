<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Engaging Budget Planner â€” 50/30/20 (Single File)</title>

  <!-- Export libs (CDN). For fully offline, download these files and reference locally. -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ---------- Theme & reset ---------- */
    :root{
      --bg:#f3f6fb; --card:#fff; --muted:#6b7280; --text:#0f172a;
      --needs:#3b82f6; --wants:#fb923c; --savings:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text)}
    main.app{max-width:1100px;margin:18px auto;padding:14px}

    /* header */
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:1.4rem}
    .subtitle{color:var(--muted);font-size:0.95rem}

    /* layout */
    .layout{display:grid;grid-template-columns:320px 1fr;gap:14px}
    @media(max-width:880px){.layout{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(15,23,42,0.06)}
    .small{font-size:0.9rem;color:var(--muted)}

    /* controls */
    label.block{display:block;font-weight:700;margin-bottom:6px}
    input[type=number], input[type=text], select, .percent-num {width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee}
    input[type=date]{padding:8px;border-radius:8px;border:1px solid #e6e9ee}
    .row{display:flex;gap:8px;align-items:center}
    .percent-row{display:flex;gap:8px;align-items:center}
    input[type=range]{flex:1}

    /* buttons */
    .btn{background:#0f172a;color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid #e6e9ee}
    .btn.small{padding:6px 8px;font-size:0.9rem}
    .muted{color:var(--muted)}

    /* summary */
    .summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
    @media(max-width:600px){.summary-grid{grid-template-columns:1fr}}
    .summary-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.65),rgba(255,255,255,0.45))}
    .summary-value{font-weight:800;font-size:1.05rem}

    /* progress */
    .progress-row{margin-bottom:10px}
    .progress{background:#eef2ff;height:20px;border-radius:999px;overflow:hidden;margin-top:6px}
    .bar{height:100%;width:0%;transition:width 400ms cubic-bezier(.2,.9,.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:8px;color:white;font-weight:700;font-size:12px}
    .bar.needs{background:linear-gradient(90deg,var(--needs),#2563eb)}
    .bar.wants{background:linear-gradient(90deg,var(--wants),#f97316)}
    .bar.savings{background:linear-gradient(90deg,var(--savings),#059669)}

    /* engagement message */
    .coach {
      margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8));
      box-shadow:0 6px 20px rgba(2,6,23,0.06); font-weight:700; font-size:1rem; min-height:46px;
      display:flex;align-items:center;gap:12px;overflow:hidden;
    }
    .coach .emoji{font-size:1.4rem}
    .coach .text{flex:1;opacity:0;transform:translateY(6px);transition:all 260ms ease}
    .coach.show .text{opacity:1;transform:translateY(0)}

    /* table */
    .table-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    table.expenses{width:100%;border-collapse:collapse;font-size:0.95rem}
    thead th{padding:10px 8px;border-bottom:1px solid #eef2ff;text-align:left}
    tbody td{padding:10px 8px;border-bottom:1px dashed #f1f5f9}
    .tag{padding:4px 8px;border-radius:999px;font-weight:700;color:white;font-size:0.82rem}
    .tag.needs{background:var(--needs)}
    .tag.wants{background:var(--wants)}
    .tag.savings{background:var(--savings)}
    td.editing{background:#fff7ed}

    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:0.9rem}
  </style>
</head>
<body>
  <main class="app">
    <header>
      <div>
        <h1>Budget Planner</h1>
        <div class="subtitle">Default 50/30/20 â€” sliders, add/edit expenses, saving tips & playful coach messages.</div>
      </div>
      <div class="small muted">Double-click a table cell to edit â€¢ Exports: TXT / PDF / Excel</div>
    </header>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside>
        <div class="card">
          <label class="block">Monthly Income (â‚¹)</label>
          <input id="income" type="number" min="0" value="50000" />
          <div class="small muted" style="margin-top:8px">Change to see targets update live</div>
        </div>

        <div class="card" style="margin-top:12px">
          <label class="block">Allocation (drag or type)</label>

          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Needs <span class="small muted" id="needsLabelSmall">(50%)</span></div>
              <div class="small muted" id="needsTargetSmall">â‚¹ 0</div>
            </div>
            <div class="percent-row" style="margin-top:6px">
              <input id="needsRange" type="range" min="0" max="100" value="50" />
              <input id="needsNum" type="number" min="0" max="100" value="50" style="width:72px" />
            </div>
          </div>

          <div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Wants <span class="small muted" id="wantsLabelSmall">(30%)</span></div>
              <div class="small muted" id="wantsTargetSmall">â‚¹ 0</div>
            </div>
            <div class="percent-row" style="margin-top:6px">
              <input id="wantsRange" type="range" min="0" max="100" value="30" />
              <input id="wantsNum" type="number" min="0" max="100" value="30" style="width:72px" />
            </div>
          </div>

          <div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Savings <span class="small muted" id="savingsLabelSmall">(20%)</span></div>
              <div class="small muted" id="savingsTargetSmall">â‚¹ 0</div>
            </div>
            <div class="percent-row" style="margin-top:6px">
              <input id="savingsRange" type="range" min="0" max="100" value="20" />
              <input id="savingsNum" type="number" min="0" max="100" value="20" style="width:72px" />
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <div class="small">Total:</div>
            <div id="percentTotal" class="small">100%</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <label class="block">Add Expense</label>
          <form id="expenseForm">
            <div class="row" style="margin-bottom:8px">
              <input id="expAmount" type="number" placeholder="Amount (â‚¹)" min="0" required />
              <select id="expCategory">
                <option value="Needs">Needs</option>
                <option value="Wants">Wants</option>
                <option value="Savings">Savings</option>
              </select>
            </div>
            <div class="row" style="margin-bottom:8px">
              <input id="expDesc" type="text" placeholder="Description (optional)" />
              <input id="expDate" type="date" />
            </div>
            <div class="row">
              <button class="btn" type="submit">Add Expense</button>
              <button type="button" id="clearAllBtn" class="btn ghost">Clear All</button>
            </div>
          </form>
        </div>
      </aside>

      <!-- MAIN -->
      <section>
        <div class="card">
          <div class="summary-grid">
            <div class="summary-card">
              <h4>Income</h4>
              <div class="summary-value">â‚¹ <span id="incomeDisplay">50,000</span></div>
            </div>
            <div class="summary-card">
              <h4>Targets</h4>
              <div class="small">Needs: â‚¹ <span id="targetNeeds">0</span></div>
              <div class="small">Wants: â‚¹ <span id="targetWants">0</span></div>
              <div class="small">Savings: â‚¹ <span id="targetSavings">0</span></div>
            </div>
            <div class="summary-card">
              <h4>Quick Actions</h4>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="exportTxt" class="btn small">Export TXT</button>
                <button id="exportPdf" class="btn small ghost">Export PDF</button>
                <button id="exportXlsx" class="btn small">Export Excel</button>
              </div>
              <div style="margin-top:8px" class="small muted">Saved in your browser (localStorage)</div>
            </div>
          </div>

          <div style="margin-top:6px">
            <div class="progress-row">
              <label>Needs <span id="needsStatus" class="small muted"></span></label>
              <div class="progress"><div id="barNeeds" class="bar needs"></div></div>
              <div class="small" style="margin-top:6px">â‚¹ <span id="needsTotal">0</span> / <small id="needsTargetLabel">0</small></div>
            </div>

            <div class="progress-row">
              <label>Wants <span id="wantsStatus" class="small muted"></span></label>
              <div class="progress"><div id="barWants" class="bar wants"></div></div>
              <div class="small" style="margin-top:6px">â‚¹ <span id="wantsTotal">0</span> / <small id="wantsTargetLabel">0</small></div>
            </div>

            <div class="progress-row">
              <label>Savings <span id="savingsStatus" class="small muted"></span></label>
              <div class="progress"><div id="barSavings" class="bar savings"></div></div>
              <div class="small" style="margin-top:6px">â‚¹ <span id="savingsTotal">0</span> / <small id="savingsTargetLabel">0</small></div>
            </div>

            <!-- Coach (fun messages) -->
            <div id="coach" class="coach">
              <div class="emoji" id="coachEmoji">ðŸ§¾</div>
              <div class="text" id="coachText">Smart coach will appear here.</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="table-head">
            <h3 style="margin:0">Expenses</h3>
            <div style="display:flex;gap:8px">
              <button id="sortDateBtn" class="btn ghost small">Sort: Date</button>
              <button id="sortCategoryBtn" class="btn ghost small">Sort: Category</button>
            </div>
          </div>

          <table class="expenses" id="expensesTable">
            <thead>
              <tr><th>#</th><th>Amount (â‚¹)</th><th>Category</th><th>Description</th><th>Date</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer class="muted">Open locally or host on GitHub Pages. For offline export, host the XLSX & jsPDF scripts locally.</footer>
  </main>

  <script>
  /* -------------------------
     Engaging Budget Planner JS
     - Single-file app
     - Adds "coach" personality messages with emoji
     - All features: sliders, redistribution, expense add/edit/delete, localStorage, exports
     ------------------------- */

  /* ===== DOM refs ===== */
  const incomeEl = document.getElementById('income'), incomeDisplay = document.getElementById('incomeDisplay');
  const needsRange = document.getElementById('needsRange'), wantsRange = document.getElementById('wantsRange'), savingsRange = document.getElementById('savingsRange');
  const needsNum = document.getElementById('needsNum'), wantsNum = document.getElementById('wantsNum'), savingsNum = document.getElementById('savingsNum');
  const needsLabelSmall = document.getElementById('needsLabelSmall'), wantsLabelSmall = document.getElementById('wantsLabelSmall'), savingsLabelSmall = document.getElementById('savingsLabelSmall');
  const percentTotalEl = document.getElementById('percentTotal');
  const targetNeeds = document.getElementById('targetNeeds'), targetWants = document.getElementById('targetWants'), targetSavings = document.getElementById('targetSavings');
  const needsTargetLabel = document.getElementById('needsTargetLabel'), wantsTargetLabel = document.getElementById('wantsTargetLabel'), savingsTargetLabel = document.getElementById('savingsTargetLabel');
  const needsTotalEl = document.getElementById('needsTotal'), wantsTotalEl = document.getElementById('wantsTotal'), savingsTotalEl = document.getElementById('savingsTotal');
  const barNeeds = document.getElementById('barNeeds'), barWants = document.getElementById('barWants'), barSavings = document.getElementById('barSavings');
  const needsStatus = document.getElementById('needsStatus'), wantsStatus = document.getElementById('wantsStatus'), savingsStatus = document.getElementById('savingsStatus');
  const coach = document.getElementById('coach'), coachText = document.getElementById('coachText'), coachEmoji = document.getElementById('coachEmoji');

  const expenseForm = document.getElementById('expenseForm'), expAmount = document.getElementById('expAmount'), expCategory = document.getElementById('expCategory'), expDesc = document.getElementById('expDesc'), expDate = document.getElementById('expDate');
  const expensesTableBody = document.querySelector('#expensesTable tbody');
  const exportTxtBtn = document.getElementById('exportTxt'), exportPdfBtn = document.getElementById('exportPdf'), exportXlsxBtn = document.getElementById('exportXlsx');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const sortDateBtn = document.getElementById('sortDateBtn'), sortCategoryBtn = document.getElementById('sortCategoryBtn');

  /* ===== State & persistence ===== */
  const STORAGE_KEY = 'engaging_budget_v1';
  let state = {
    income: 50000,
    percents: { needs:50, wants:30, savings:20 },
    expenses: [], // {id,amount,category,desc,date}
    sort: { by:'date', dir:'desc' }
  };

  function saveState(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){} }
  function loadState(){ try { const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); } catch(e){ console.error(e);} }

  /* ===== Utilities ===== */
  const currency = n => Math.round(n).toLocaleString();
  const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2,6);

  /* ===== Coach message banks ===== */
  const messages = {
    overspend: [
      {emoji:'ðŸ‘‘', text:"Whoa! Youâ€™re living like a Lavish King â€” check that spending!"},
      {emoji:'ðŸ’¸', text:"Careful â€” your expenses are partying harder than your wallet."},
      {emoji:'ðŸ”¥', text:"Hot spender alert! Maybe pause the cart for a day?"}
    ],
    wantsLavish: [
      {emoji:'ðŸ›ï¸', text:"Your wishlist is thriving â€” your Wants are being fed well ðŸ˜…"},
      {emoji:'ðŸ‘‘', text:"Lavish taste! You're treating yourself like royalty."}
    ],
    savingsMaster: [
      {emoji:'ðŸ†', text:"Saving Master! You're building a future fortress â€” bravo!"},
      {emoji:'ðŸš€', text:"Top saver vibes. You're stacking wealth like a pro."},
      {emoji:'ðŸ’Ž', text:"You're a savings legend â€” top 10% energy!"}
    ],
    balanced: [
      {emoji:'ðŸ§˜', text:"Perfect balance â€” Sensei of Finance."},
      {emoji:'ðŸŒ±', text:"Balanced and steady. Keep the momentum!"}
    ],
    minimalist: [
      {emoji:'ðŸª´', text:"Minimalist mode â€” are you skipping essentials or living stress-free?"},
      {emoji:'ðŸ§­', text:"You're frugal â€” that's discipline (and power)."}
    ],
    cheeky: [
      {emoji:'ðŸ˜‚', text:"Your Amazon cart is crying with joy."},
      {emoji:'ðŸ¤´', text:"Youâ€™re treating life like a luxury ad â€” bold move."}
    ],
    motivateSaving: [
      {emoji:'âš¡', text:"Save small, win big â€” compound interest is your friend."},
      {emoji:'ðŸŒŸ', text:"Every rupee saved is a tiny rebel against future stress."}
    ]
  };

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  /* ===== Personality engine: decide which message to show ===== */
  let lastCoachKey = null;
  function updateCoach(totals, targets){
    // totals & targets: {needs,wants,savings}
    // pick situation
    const overNeeds = totals.needs > targets.needs;
    const overWants = totals.wants > targets.wants;
    const belowSavings = totals.savings < targets.savings;
    const highSavings = totals.savings >= targets.savings * 1.2; // 20% above target
    const lowNeeds = totals.needs < (targets.needs * 0.5); // extreme low needs

    let bankKey = 'balanced';

    if (overNeeds && overWants) bankKey = 'overspend';
    else if (overNeeds) bankKey = 'overspend';
    else if (overWants && !overNeeds) bankKey = 'wantsLavish';
    else if (highSavings) bankKey = 'savingsMaster';
    else if (belowSavings) bankKey = 'motivateSaving';
    else if (lowNeeds) bankKey = 'minimalist';
    else bankKey = 'balanced';

    // occasionally add cheeky tag when overspending on wants
    if (overWants && Math.random() < 0.25) bankKey = 'cheeky';

    const chosen = pick(messages[bankKey]);
    // avoid flicker with same key repeated â€” but allow repeating sometimes
    if(bankKey === lastCoachKey && Math.random() < 0.5){
      // choose different message in same bank to keep it fresh
      const alt = pick(messages[bankKey]);
      coachEmoji.textContent = alt.emoji;
      coachText.textContent = alt.text;
    } else {
      coachEmoji.textContent = chosen.emoji;
      coachText.textContent = chosen.text;
    }
    lastCoachKey = bankKey;
    // animate
    coach.classList.remove('show');
    setTimeout(()=> coach.classList.add('show'), 40);
  }

  /* ===== Redistribution algorithm for sliders ===== */
  function redistribute(changedKey, newValue){
    newValue = Math.max(0, Math.min(100, Math.round(newValue)));
    const p = {...state.percents};
    const oldVal = p[changedKey];
    const delta = newValue - oldVal;
    if(delta === 0) return;
    const others = Object.keys(p).filter(k=>k!==changedKey);
    let a = p[others[0]], b = p[others[1]], totalOthers = a + b;
    if(totalOthers === 0){ a = b = 50; totalOthers = 100; }
    let newA = a - (delta * (a/totalOthers));
    let newB = b - (delta * (b/totalOthers));
    newA = Math.max(0, Math.min(100, Math.round(newA)));
    newB = Math.max(0, Math.min(100, Math.round(newB)));
    newValue = Math.max(0, Math.min(100, Math.round(newValue)));
    let total = newA + newB + newValue;
    const drift = total - 100;
    newValue = Math.round(newValue - drift);
    state.percents[changedKey] = newValue;
    state.percents[others[0]] = newA;
    state.percents[others[1]] = newB;
    syncPercents();
    updateAll();
  }

  function syncPercents(){
    needsRange.value = state.percents.needs; wantsRange.value = state.percents.wants; savingsRange.value = state.percents.savings;
    needsNum.value = state.percents.needs; wantsNum.value = state.percents.wants; savingsNum.value = state.percents.savings;
    needsLabelSmall.textContent = `(${state.percents.needs}%)`; wantsLabelSmall.textContent = `(${state.percents.wants}%)`; savingsLabelSmall.textContent = `(${state.percents.savings}%)`;
    percentTotalEl.textContent = (state.percents.needs + state.percents.wants + state.percents.savings) + '%';
  }

  /* ===== Events: sliders & numbers ===== */
  needsRange.addEventListener('input', e=>redistribute('needs', Number(e.target.value)));
  wantsRange.addEventListener('input', e=>redistribute('wants', Number(e.target.value)));
  savingsRange.addEventListener('input', e=>redistribute('savings', Number(e.target.value)));
  needsNum.addEventListener('input', e=>redistribute('needs', Number(e.target.value)));
  wantsNum.addEventListener('input', e=>redistribute('wants', Number(e.target.value)));
  savingsNum.addEventListener('input', e=>redistribute('savings', Number(e.target.value)));

  /* ===== Expense handling ===== */
  document.getElementById('expenseForm').addEventListener('submit', ev=>{
    ev.preventDefault();
    const amt = Math.round(Number(expAmount.value) || 0);
    if(amt <= 0){ flashCoach('Enter a positive amount!', 'âš ï¸'); return; }
    const expense = {
      id: uid(), amount: amt, category: expCategory.value,
      desc: expDesc.value.trim(), date: expDate.value || (new Date()).toISOString().slice(0,10)
    };
    state.expenses.push(expense);
    expAmount.value=''; expDesc.value=''; expDate.value='';
    saveState(); updateAll();
    flashCoach('Expense added', 'âœ…');
  });

  clearAllBtn.addEventListener('click', ()=>{
    if(!confirm('Clear all expenses?')) return;
    state.expenses = [];
    saveState(); updateAll();
    flashCoach('All expenses cleared', 'ðŸ§¹');
  });

  /* ===== Sorting ===== */
  sortDateBtn.addEventListener('click', ()=>{
    if(state.sort.by==='date') state.sort.dir = (state.sort.dir==='asc'?'desc':'asc'); else { state.sort.by='date'; state.sort.dir='desc'; }
    updateAll();
  });
  sortCategoryBtn.addEventListener('click', ()=>{
    if(state.sort.by==='category') state.sort.dir = (state.sort.dir==='asc'?'desc':'asc'); else { state.sort.by='category'; state.sort.dir='asc'; }
    updateAll();
  });

  /* ===== Export functions ===== */
  exportTxtBtn.addEventListener('click', exportTxt);
  exportPdfBtn.addEventListener('click', exportPdf);
  exportXlsxBtn.addEventListener('click', exportXlsx);

  function exportTxt(){
    const now = new Date().toLocaleString(); const lines=[];
    lines.push('Budget Planner Report'); lines.push('Generated: '+now); lines.push('');
    lines.push(`Income: â‚¹ ${currency(state.income)}`);
    lines.push(`Percents: Needs ${state.percents.needs}% | Wants ${state.percents.wants}% | Savings ${state.percents.savings}%`);
    lines.push('Targets:'); lines.push(`  Needs: â‚¹ ${currency(target('needs'))}`); lines.push(`  Wants: â‚¹ ${currency(target('wants'))}`); lines.push(`  Savings: â‚¹ ${currency(target('savings'))}`);
    lines.push(''); lines.push('Expenses:');
    if(state.expenses.length===0) lines.push('  (No expenses)');
    else state.expenses.forEach((e,i)=>lines.push(`${i+1}. â‚¹ ${currency(e.amount)} | ${e.category} | ${e.desc || '-'} | ${e.date || '-'}`));
    const blob = new Blob([lines.join('\n')], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `budget-${Date.now()}.txt`; a.click();
    URL.revokeObjectURL(a.href);
  }

  function exportPdf(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'});
    doc.setFontSize(14); doc.text('Budget Planner Report',40,50);
    doc.setFontSize(10); doc.text('Income: â‚¹ '+currency(state.income),40,68);
    doc.text(`Percents: Needs ${state.percents.needs}% | Wants ${state.percents.wants}% | Savings ${state.percents.savings}%`,40,84);
    const head = [['#','Amount (â‚¹)','Category','Description','Date']];
    const body = state.expenses.map((e,i)=>[i+1, currency(e.amount), e.category, e.desc || '-', e.date || '-']);
    doc.autoTable({ startY:110, head, body, styles:{fontSize:9} });
    doc.save(`budget-${Date.now()}.pdf`);
  }

  function exportXlsx(){
    const wb = XLSX.utils.book_new(); const rows=[];
    rows.push(['Budget Planner Report']); rows.push(['Generated', new Date().toLocaleString()]); rows.push([]);
    rows.push(['Income', state.income]); rows.push(['Needs %', state.percents.needs]); rows.push(['Wants %', state.percents.wants]); rows.push(['Savings %', state.percents.savings]); rows.push([]);
    rows.push(['Expenses']); rows.push(['#','Amount','Category','Description','Date']);
    state.expenses.forEach((e,i)=>rows.push([i+1, e.amount, e.category, e.desc || '-', e.date || '-']));
    const ws = XLSX.utils.aoa_to_sheet(rows); XLSX.utils.book_append_sheet(wb, ws, 'Report'); XLSX.writeFile(wb, `budget-${Date.now()}.xlsx`);
  }

  /* ===== Helpers & calculations ===== */
  function target(kind){ return Math.round((state.percents[kind]/100) * state.income); }
  function totalsByCategory(){
    let n=0,w=0,s=0; state.expenses.forEach(e=>{ if(e.category==='Needs') n+=e.amount; else if(e.category==='Wants') w+=e.amount; else s+=e.amount; });
    return {needs:n,wants:w,savings:s};
  }

  /* ===== Render functions ===== */
  function renderExpensesTable(){
    let list = [...state.expenses];
    if(state.sort.by==='date'){
      list.sort((a,b)=>{
        if(!a.date) return 1; if(!b.date) return -1;
        return state.sort.dir==='asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date);
      });
    } else if(state.sort.by==='category'){
      list.sort((a,b)=> state.sort.dir==='asc' ? a.category.localeCompare(b.category) : b.category.localeCompare(a.category));
    }
    expensesTableBody.innerHTML = '';
    list.forEach((e, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td class="cell amount" data-id="${e.id}">â‚¹ ${currency(e.amount)}</td>
        <td class="cell category" data-id="${e.id}"><span class="tag ${e.category.toLowerCase()}">${e.category}</span></td>
        <td class="cell desc" data-id="${e.id}">${e.desc || '-'}</td>
        <td class="cell date" data-id="${e.id}">${e.date || '-'}</td>
        <td class="actions"><button class="btn ghost small" data-delete="${e.id}">Delete</button></td>
      `;
      expensesTableBody.appendChild(tr);
    });

    // delete handlers
    expensesTableBody.querySelectorAll('button[data-delete]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const id = e.currentTarget.getAttribute('data-delete');
        if(!confirm('Delete this expense?')) return;
        state.expenses = state.expenses.filter(x=>x.id !== id);
        saveState(); updateAll();
        flashCoach('Expense deleted', 'ðŸ—‘ï¸');
      });
    });

    // editable cells on double click
    expensesTableBody.querySelectorAll('td.cell').forEach(td=>{
      td.addEventListener('dblclick', ev=>makeCellEditable(ev.currentTarget));
    });
  }

  function makeCellEditable(td){
    const id = td.getAttribute('data-id'); if(!id) return;
    td.classList.add('editing');
    const isAmount = td.classList.contains('amount');
    const isDate = td.classList.contains('date');
    const originalValue = td.textContent.trim();
    let input = document.createElement('input');
    if(isAmount){ input.type='number'; input.value = state.expenses.find(x=>x.id===id).amount; input.min=0; }
    else if(isDate){ input.type='date'; input.value = state.expenses.find(x=>x.id===id).date || ''; }
    else { input.type='text'; input.value = state.expenses.find(x=>x.id===id).desc || ''; }
    input.style.width = '100%';
    td.innerHTML = ''; td.appendChild(input); input.focus();

    function commit(){
      const val = input.value;
      const idx = state.expenses.findIndex(x=>x.id===id); if(idx===-1) return;
      if(isAmount){ state.expenses[idx].amount = Math.round(Number(val)||0); }
      else if(isDate){ state.expenses[idx].date = val; }
      else { state.expenses[idx].desc = val; }
      td.classList.remove('editing');
      saveState(); updateAll();
    }
    input.addEventListener('blur', commit);
    input.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ input.blur(); } if(ev.key==='Escape'){ td.classList.remove('editing'); updateAll(); } });
  }

  function updateSummaryAndBars(){
    incomeDisplay.textContent = currency(state.income);
    targetNeeds.textContent = currency(target('needs')); targetWants.textContent = currency(target('wants')); targetSavings.textContent = currency(target('savings'));
    needsTargetLabel.textContent = currency(target('needs')); wantsTargetLabel.textContent = currency(target('wants')); savingsTargetLabel.textContent = currency(target('savings'));
    const totals = totalsByCategory();
    needsTotalEl.textContent = currency(totals.needs); wantsTotalEl.textContent = currency(totals.wants); savingsTotalEl.textContent = currency(totals.savings);

    const needsPct = target('needs') === 0 ? 0 : Math.round((totals.needs/target('needs'))*100);
    const wantsPct = target('wants') === 0 ? 0 : Math.round((totals.wants/target('wants'))*100);
    const savingsPct = target('savings') === 0 ? 0 : Math.round((totals.savings/target('savings'))*100);

    barNeeds.style.width = Math.min(100, needsPct) + '%'; barNeeds.textContent = needsPct>0? needsPct+'%':''; barWants.style.width = Math.min(100, wantsPct) + '%'; barWants.textContent = wantsPct>0? wantsPct+'%':''; barSavings.style.width = Math.min(100, savingsPct) + '%'; barSavings.textContent = savingsPct>0? savingsPct+'%':'';

    needsStatus.textContent = totals.needs > target('needs') ? 'Exceeded' : ''; wantsStatus.textContent = totals.wants > target('wants') ? 'Exceeded' : ''; savingsStatus.textContent = totals.savings < target('savings') ? 'Below target' : '';

    // coach message
    updateCoach(totals, {needs: target('needs'), wants: target('wants'), savings: target('savings')});
  }

  /* Quick flash near coach (small temporary message) */
  function flashCoach(msg, emoji='â„¹ï¸'){
    coachEmoji.textContent = emoji; coachText.textContent = msg; coach.classList.remove('show'); setTimeout(()=>coach.classList.add('show'),30);
  }

  /* ===== Persistence & initialization ===== */
  function seedDemoIfEmpty(){
    if(!state.expenses || state.expenses.length===0){
      state.expenses = [
        {id:uid(), amount:12000, category:'Needs', desc:'Rent', date:'2025-07-01'},
        {id:uid(), amount:4500, category:'Needs', desc:'Groceries', date:'2025-07-03'},
        {id:uid(), amount:3000, category:'Wants', desc:'Dining out', date:'2025-07-08'},
        {id:uid(), amount:2000, category:'Wants', desc:'Movies', date:'2025-07-15'},
        {id:uid(), amount:5000, category:'Savings', desc:'Emergency fund', date:'2025-07-20'}
      ];
    }
  }

  function updateAll(){
    syncPercents(); incomeEl.value = state.income; renderExpensesTable(); updateSummaryAndBars(); saveState();
  }

  // Income change listener
  incomeEl.addEventListener('input', ()=>{ state.income = Math.max(0, Math.round(Number(incomeEl.value)||0)); saveState(); updateAll(); });

  /* ===== Startup ===== */
  (function init(){
    loadState();
    if(!state.percents) state.percents = {needs:50,wants:30,savings:20};
    if(!state.income) state.income = 50000;
    seedDemoIfEmpty();
    syncPercents();
    updateAll();
  })();

  /* Accessibility: press Enter in amount to submit */
  expAmount.addEventListener('keydown', e=>{ if(e.key==='Enter') expenseForm.requestSubmit(); });
  </script>
</body>
</html>
